### Author: Ivy Zhang

## Extracting snapshots from Folding@home data
The RBD:ACE2 structures in this directory come from the data generated by the structure in `../WT` on Folding@home (`Project 17309`). We extracted the last frame from one CLONE (CLONE2, 290 ns long) by removing solvent (and solvent ions), aligning the frame to `./PDBs/rbd_ace2_no_water.pdb` (which is the equiilibrated structure from `17309` with solvent stripped), and the writing to a PDB file. See `extract_frames.ipynb` for the code used to extract the frame.

This frame is located in `./PDBs/01_with_h/`

## Prep WT
To prep the frames as WT:
1. The frame in `./PDBs/01_with_h/` was loaded into PyMOL and hydrogens were removed (`remove hydrogens`)

The frame can be found here: `./PDBs/02_after_pymol/` and does not have `TER`s.

2. TER cards were added after each glycan and TER cards for NMEs (which were present before the NME residues) were moved to after the last NME residue line. The script used to do this: `./PDBs/correct_ters.py`

The frame can be found here: `./PDBs/03_corrected/`

3. The residue ids were renamed to their canonical numbering (so that we can use Will's `bond` commands in `tleap`) and the single chain was split into multiple chains. We also split the frame into two PDBs: one for RBD and one for ACE2. The script used to do this: `PDBS/correct_chain_residue_ids.py`

The frame can be found here: `./PDBs/04_renumbered/`

3. The C atoms in NME was renamed to CH3, the CYS residues involved in disulfide bonds were renamed to CYX, and the CONECT records were deleted (all of which is necessary for `tleap` residue template matching).To do this, `PDBs/correct_NME_CYS_CONECT.py` was used.

The final, prepped frames can be found here: `./PDBs/05_conect_removed/*_final.pdb` 

## Prep mutants
The mutants we want:
- N439K (108)
- K417V (86)
- N439K / K417V (108, 86)

However, since `tleap` merges all chains into one and renumbers the residues, the frames extracted from F@h have different residue numbers than the original PDB. As such, I have annotated the corresponding residue nummbers in our F@h structures above in parantheses.

To make the 3 mutant structures, we used the [PyMOL mutagenesis wizard](https://pymolwiki.org/index.php/Mutagenesis).
For each mutant, we selected the highest probability rotamer with the least number of clashes. We then removed hydrogens. 

The structures can be found here: `./PDBs/02_after_pymol/` and do not have `TER`s.

Finally, we followed steps 2-4 above to correct the TER cards, renumber the residue/chain ids, and correct the NME, CYS, and CONECT records. 

## Running tleap

Location: `./run_tleap/`

We used tleap to solvate the systems and parametrize them. We did this separately for each of the 4 systems, each of which has a separate directory in `./run_tleap`. Below, we detail how to parametrize the N439K mutant. The same process was repeated for all systems.

### Addition of solvent and ions

Within the `17309_CLONE2_GEN58_N438K_tleap.in` file the `solvateBox` command solvates the system and the `addIonsRand` command replaces water molecules with Na+ and Cl- ions. 

The AMBER `tleap` program does not automatically work out the correct number of ions for a given system / system charge. In order for this to be determined we use the methodology from OpenMM:

```python
from math import floor
numWaters = 64032
numPositive = 0
numNegative = 0 
totalCharge = -19
ionicStrength = 0.15

if totalCharge > 0:
    numNegative += totalCharge
else:
    numPositive -= totalCharge

numIons = (numWaters - numPositive - numNegative) * ionicStrength / (55.4)  # Pure water is about 55.4 molar (depending on temperature)
numPairs = int(floor(numIons + 0.5))
numPositive += numPairs
numNegative += numPairs
```

The `numWaters` variable was determined by running the `17309_CLONE2_GEN58_N439K_tleap.in` script *without* adding ions first. The above method gave `numPositive` (i.e. Na+) as 192 and `numNegative` (i.e. Cl-) as 173.

Note the number of waters/charge used to compute the number of ions for each system is noted in each of the `[system_name]_tleap.in` files.

## Running tleap
The tleap commands we ran are present in `[system_name]_tleap.in`.

This produced fully solvated (with ions) systems. Check the `leap.log` files for full descriptions of the output. The `.prmtop` and `.inpcrd` files could now be used for minimisation and equilibration. The generated system can be viewed here: `./run_tleap/*/[system_name]_out.pdb`, though note that tleap combines all chains into 1, so it is a bit difficult to use PyMOL to manipulate the system.

## Equilibration

Once prepared the system was equilibrated here: `./equil`

Note that since `tleap` combines chains and renumbers the residue ids, we split the chains and renumbered the residues for `equilibrated.pdb`s according to canonical numbering using `.equil/correct_equilibrated.py`
